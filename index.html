<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Luxury Carousel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #050300; font-family: serif; overflow: hidden; color: white; }
        canvas { touch-action: none; width: 100%; height: 100vh; }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050300; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            color: #D4AF37; transition: opacity 0.8s ease;
        }
        .spinner { width: 50px; height: 50px; border: 3px solid rgba(212, 175, 55, 0.1); border-top-color: #D4AF37; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #error-log {
            position: fixed; bottom: 10px; left: 10px; color: red; font-size: 10px; 
            z-index: 200; max-width: 80%; word-break: break-all; pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 25px; letter-spacing: 0.5em; font-size: 10px;">LOADING 3D ENGINE...</p>
    </div>
    <div id="error-log"></div>
    <div id="root"></div>

    <script type="module">
        // 错误捕获：如果脚本崩溃，在屏幕上显示错误
        window.onerror = function(msg, url, line) {
            document.getElementById('error-log').innerText = "Error: " + msg + "\nLine: " + line;
        };

        // 直接从 esm.sh 导入，不依赖 importmap，增加稳定性
        import React, { useState, useRef, useMemo, useEffect, Suspense } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import * as THREE from 'https://esm.sh/three@0.160.0';
        import { Canvas, useFrame } from 'https://esm.sh/@react-three/fiber@8.15.11?external=react,three';
        import { Float, Environment, Text, OrbitControls, MeshWobbleMaterial } from 'https://esm.sh/@react-three/drei@9.88.11?external=react,three';

        const STATE = { CHAOS: 'CHAOS', FORMED: 'FORMED' };

        const CarouselElements = ({ state }) => {
            const meshRef = useRef();
            const temp = new THREE.Object3D();
            const data = useMemo(() => Array.from({ length: 40 }).map((_, i) => ({
                chaos: new THREE.Vector3((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*30),
                angle: (i / 40) * Math.PI * 2,
                radius: 7 + Math.sin(i) * 2,
                y: (Math.random()-0.5) * 6
            })), []);

            useFrame((s) => {
                const isChaos = state === STATE.CHAOS;
                data.forEach((item, i) => {
                    if (isChaos) {
                        temp.position.lerp(item.chaos, 0.05);
                        temp.rotation.x += 0.01;
                    } else {
                        const a = item.angle + s.clock.elapsedTime * 0.2;
                        temp.position.lerp(new THREE.Vector3(Math.cos(a)*item.radius, item.y, Math.sin(a)*item.radius), 0.05);
                        temp.rotation.set(0, -a + Math.PI/2, 0);
                    }
                    temp.updateMatrix();
                    meshRef.current.setMatrixAt(i, temp.matrix);
                });
                meshRef.current.instanceMatrix.needsUpdate = true;
            });
            return React.createElement('instancedMesh', { ref: meshRef, args: [null, null, 40] }, [
                React.createElement('boxGeometry', { args: [0.4, 0.8, 0.4] }),
                React.createElement('meshStandardMaterial', { color: "#D4AF37", metalness: 0.9, roughness: 0.1 })
            ]);
        };

        function App() {
            const [appState, setAppState] = useState(STATE.FORMED);
            
            useEffect(() => {
                const loader = document.getElementById('loader');
                // 3秒后无论如何关闭加载动画
                const timer = setTimeout(() => {
                    if (loader) {
                        loader.style.opacity = '0';
                        setTimeout(() => loader.style.display = 'none', 800);
                    }
                }, 3000);
                return () => clearTimeout(timer);
            }, []);

            return React.createElement('div', { className: "w-full h-screen relative" }, [
                React.createElement(Canvas, { camera: { position: [0, 5, 25], fov: 45 } }, [
                    React.createElement(Suspense, { fallback: null }, [
                        React.createElement(Environment, { preset: "city" }),
                        React.createElement(Float, { speed: 2 }, 
                            React.createElement('mesh', null, [
                                React.createElement('sphereGeometry', { args: [2, 32, 32] }),
                                React.createElement(MeshWobbleMaterial, { factor: 0.4, speed: 1.5, color: "#FFD700", emissive: "#FF4500", emissiveIntensity: 0.5 })
                            ])
                        ),
                        React.createElement(CarouselElements, { state: appState }),
                        React.createElement(OrbitControls, { enablePan: false })
                    ]),
                    React.createElement('ambientLight', { intensity: 0.5 }),
                    React.createElement('pointLight', { position: [10, 10, 10], intensity: 1 })
                ]),
                
                // 控制按钮
                React.createElement('div', { className: "fixed bottom-10 left-1/2 -translate-x-1/2 z-50 flex gap-4" }, [
                    React.createElement('button', {
                        onClick: () => setAppState(STATE.CHAOS),
                        className: `px-6 py-2 rounded-full border border-yellow-500/50 text-white text-[10px] uppercase tracking-widest ${appState === STATE.CHAOS ? 'bg-red-600' : 'bg-black/50'}`
                    }, "Unleash Chaos"),
                    React.createElement('button', {
                        onClick: () => setAppState(STATE.FORMED),
                        className: `px-6 py-2 rounded-full border border-yellow-500/50 text-white text-[10px] uppercase tracking-widest ${appState === STATE.FORMED ? 'bg-yellow-600 text-black' : 'bg-black/50'}`
                    }, "Restore Order")
                ])
            ]);
        }

        createRoot(document.getElementById('root')).render(React.createElement(App));
    </script>
</body>
</html>
