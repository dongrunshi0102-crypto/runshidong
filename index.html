<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Luxury Interactive Carousel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        body { margin: 0; background: #050300; font-family: 'Playfair Display', serif; overflow: hidden; }
        canvas { touch-action: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- å¯¼å…¥ React å’Œä¾èµ–åº“çš„ CDN é“¾æŽ¥ -->
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@19?dev",
          "react-dom": "https://esm.sh/react-dom@19?dev",
          "react-dom/client": "https://esm.sh/react-dom@19/client?dev",
          "three": "https://esm.sh/three@0.170.0",
          "@react-three/fiber": "https://esm.sh/@react-three/fiber@9?external=react,react-dom,three",
          "@react-three/drei": "https://esm.sh/@react-three/drei@9?external=react,react-dom,three"
        }
      }
    </script>

    <script type="module">
        import React, { useState, useRef, useMemo, useEffect, Suspense } from 'react';
        import { createRoot } from 'react-dom/client';
        import * as THREE from 'three';
        import { Canvas, useFrame } from '@react-three/fiber';
        import { Float, Environment, Text, OrbitControls, PerspectiveCamera, MeshWobbleMaterial } from '@react-three/drei';

        const STATE = { CHAOS: 'CHAOS', FORMED: 'FORMED' };
        const INSTANCE_COUNT = 80;
        const POLAROID_COUNT = 15;

        // æ‰‹åŠ¿æŽ§åˆ¶å™¨ç»„ä»¶
        const GestureController = ({ onStateChange, currentState }) => {
            const videoRef = useRef(null);

            useEffect(() => {
                async function setupCamera() {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                        if (videoRef.current) videoRef.current.srcObject = stream;
                    } catch (err) {
                        console.warn("ç›¸æœºæƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨ HTTPS çŽ¯å¢ƒä¸‹æ‰“å¼€");
                    }
                }
                setupCamera();
            }, []);

            return React.createElement('div', { className: "fixed bottom-6 left-6 z-50 p-5 bg-black/80 backdrop-blur-2xl rounded-3xl border border-yellow-500/30 text-white shadow-2xl" }, [
                React.createElement('div', { className: "flex items-center gap-3 mb-4", key: 'header' }, [
                    React.createElement('div', { className: "w-2 h-2 rounded-full bg-yellow-500 animate-ping" }),
                    React.createElement('h3', { className: "text-yellow-500 font-bold text-xs tracking-widest uppercase" }, "Vision AI System")
                ]),
                React.createElement('div', { className: "relative mb-4 overflow-hidden rounded-xl border border-white/5 bg-neutral-900", key: 'video' }, [
                    React.createElement('video', { ref: videoRef, autoPlay: true, playsInline: true, muted: true, className: "w-48 h-36 object-cover grayscale brightness-50" })
                ]),
                React.createElement('div', { className: "grid grid-cols-2 gap-3", key: 'buttons' }, [
                    React.createElement('button', {
                        onClick: () => onStateChange(STATE.CHAOS),
                        className: `py-3 rounded-xl text-[10px] uppercase ${currentState === STATE.CHAOS ? 'bg-red-500' : 'bg-white/5 border border-white/10'}`
                    }, "ðŸ–ï¸ Unleash"),
                    React.createElement('button', {
                        onClick: () => onStateChange(STATE.FORMED),
                        className: `py-3 rounded-xl text-[10px] uppercase ${currentState === STATE.FORMED ? 'bg-yellow-500 text-black' : 'bg-white/5 border border-white/10'}`
                    }, "âœŠ Formed")
                ])
            ]);
        };

        // 3D æ ¸å¿ƒé€»è¾‘
        const CarouselElements = ({ state }) => {
            const meshRef = useRef();
            const tempObject = new THREE.Object3D();
            const data = useMemo(() => Array.from({ length: INSTANCE_COUNT }).map((_, i) => ({
                chaosPos: new THREE.Vector3((Math.random() - 0.5) * 50, (Math.random() - 0.5) * 50, (Math.random() - 0.5) * 50),
                angleOffset: (i / INSTANCE_COUNT) * Math.PI * 2,
                heightOffset: (Math.random() - 0.5) * 10,
                radiusOffset: 8 + Math.sin(i) * 2,
                speed: 0.01 + Math.random() * 0.02
            })), []);

            useFrame((stateFrame) => {
                const time = stateFrame.clock.getElapsedTime();
                const isChaos = state === STATE.CHAOS;
                data.forEach((item, i) => {
                    let targetX, targetY, targetZ, rotX = 0, rotY = 0, rotZ = 0;
                    if (isChaos) {
                        targetX = item.chaosPos.x; targetY = item.chaosPos.y; targetZ = item.chaosPos.z;
                        rotX = time * item.speed * 5; rotY = time * item.speed * 5;
                    } else {
                        const angle = item.angleOffset + time * 0.4;
                        targetX = Math.cos(angle) * item.radiusOffset;
                        targetZ = Math.sin(angle) * item.radiusOffset;
                        targetY = item.heightOffset + Math.sin(time + i) * 0.5;
                        rotY = -angle + Math.PI / 2;
                    }
                    tempObject.position.lerp(new THREE.Vector3(targetX, targetY, targetZ), 0.06);
                    tempObject.rotation.set(rotX, rotY, rotZ);
                    tempObject.updateMatrix();
                    meshRef.current.setMatrixAt(i, tempObject.matrix);
                });
                meshRef.current.instanceMatrix.needsUpdate = true;
            });

            return React.createElement('instancedMesh', { ref: meshRef, args: [null, null, INSTANCE_COUNT] }, [
                React.createElement('boxGeometry', { args: [0.4, 0.8, 0.4] }),
                React.createElement('meshStandardMaterial', { color: "#D4AF37", metalness: 1, roughness: 0.1 })
            ]);
        };

        const Polaroid = ({ index, total, state }) => {
            const ref = useRef();
            const [chaosPos] = useState(() => new THREE.Vector3((Math.random() - 0.5) * 40, (Math.random() - 0.5) * 40, (Math.random() - 0.5) * 40));
            useFrame(({ clock }) => {
                const time = clock.getElapsedTime();
                const isChaos = state === STATE.CHAOS;
                const angle = (index / total) * Math.PI * 2 + time * 0.25;
                const targetPos = new THREE.Vector3(Math.cos(angle) * 14, Math.sin(index * 2 + time) * 2 + 3, Math.sin(angle) * 14);
                ref.current.position.lerp(isChaos ? chaosPos : targetPos, 0.05);
                if (!isChaos) ref.current.lookAt(0, 3, 0); else ref.current.rotation.z += 0.01;
            });
            return React.createElement('group', { ref: ref }, [
                React.createElement('mesh', null, [
                    React.createElement('planeGeometry', { args: [2.5, 3] }),
                    React.createElement('meshStandardMaterial', { color: "white" })
                ]),
                React.createElement('Text', { 
                    position: [0, -1.1, 0.03], fontSize: 0.14, color: "#222", 
                    font: "https://fonts.gstatic.com/s/playfairdisplay/v30/nuFvD7K_RW7ePaDXvK6drp8.woff" 
                }, `Moment #${index}`)
            ]);
        };

        const Scene = ({ state }) => {
            return React.createElement(React.Fragment, null, [
                React.createElement(PerspectiveCamera, { makeDefault: true, position: [0, 8, 28], fov: 40 }),
                React.createElement(OrbitControls, { enablePan: false, autoRotate: state === STATE.FORMED }),
                React.createElement('color', { attach: "background", args: ['#050300'] }),
                React.createElement('Suspense', { fallback: null }, [
                    React.createElement(Environment, { preset: "night" }),
                    React.createElement(Float, { speed: 4 }, [
                        React.createElement('mesh', { position: [0, 5, 0] }, [
                            React.createElement('sphereGeometry', { args: [2.5, 32, 32] }),
                            React.createElement(MeshWobbleMaterial, { factor: 0.5, speed: 2, color: "#FFD700", emissive: "#FF4500", emissiveIntensity: 2 })
                        ])
                    ]),
                    React.createElement(CarouselElements, { state: state }),
                    ...Array.from({ length: POLAROID_COUNT }).map((_, i) => 
                        React.createElement(Polaroid, { key: i, index: i, total: POLAROID_COUNT, state: state })
                    )
                ]),
                React.createElement('ambientLight', { intensity: 0.2 }),
                React.createElement('spotLight', { position: [20, 40, 20], intensity: 5, color: "#FFD700" })
            ]);
        };

        function App() {
            const [appState, setAppState] = useState(STATE.FORMED);
            return React.createElement('div', { className: "w-full h-screen" }, [
                React.createElement('div', { className: "absolute top-12 w-full z-10 text-center pointer-events-none" }, [
                    React.createElement('h1', { className: "text-6xl font-serif text-yellow-500 italic" }, "Grand Carousel")
                ]),
                React.createElement(Canvas, { shadows: true }, React.createElement(Scene, { state: appState })),
                React.createElement(GestureController, { onStateChange: setAppState, currentState: appState })
            ]);
        }

        const root = createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>
