<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grand Luxury Carousel</title>
    <!-- 引入基础库：React, Three.js, Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; background: #050300; font-family: serif; overflow: hidden; color: white; }
        #root { width: 100vw; height: 100vh; }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #050300; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 100;
            color: #D4AF37; transition: opacity 0.5s ease;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(212, 175, 55, 0.1); border-top-color: #D4AF37; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top: 20px; letter-spacing: 0.3em; font-size: 10px;">PREPARING ENGINE...</p>
    </div>
    <div id="root"></div>

    <!-- 使用 Babel 在线编译 JSX，这种方式虽然性能略低但兼容性最强 -->
    <script type="text/babel">
        // 动态加载 R3F 和 Drei (因为它们没有标准的 UMD 链接，我们手动从 esm 加载)
        const { useState, useEffect, useRef, useMemo, Suspense } = React;

        // 引入 Fiber 环境组件
        async function initApp() {
            // 如果 unpkg 挂了，这里会捕获并尝试 esm 备用方案
            try {
                const { Canvas, useFrame } = await import('https://esm.sh/@react-three/fiber@8.15.11?external=react,three');
                const { OrbitControls, Float, MeshWobbleMaterial, Environment } = await import('https://esm.sh/@react-three/drei@9.88.11?external=react,three');

                const CarouselElements = ({ state }) => {
                    const meshRef = useRef();
                    const temp = new THREE.Object3D();
                    const data = useMemo(() => Array.from({ length: 40 }).map((_, i) => ({
                        chaos: new THREE.Vector3((Math.random()-0.5)*30, (Math.random()-0.5)*30, (Math.random()-0.5)*30),
                        angle: (i / 40) * Math.PI * 2,
                        radius: 8,
                        y: (Math.random()-0.5) * 6
                    })), []);

                    useFrame((s) => {
                        const isChaos = state === 'CHAOS';
                        data.forEach((item, i) => {
                            if (isChaos) {
                                temp.position.lerp(item.chaos, 0.05);
                                temp.rotation.x += 0.01;
                            } else {
                                const a = item.angle + s.clock.elapsedTime * 0.3;
                                temp.position.lerp(new THREE.Vector3(Math.cos(a)*item.radius, item.y, Math.sin(a)*item.radius), 0.05);
                                temp.rotation.set(0, -a + Math.PI/2, 0);
                            }
                            temp.updateMatrix();
                            meshRef.current.setMatrixAt(i, temp.matrix);
                        });
                        meshRef.current.instanceMatrix.needsUpdate = true;
                    });
                    return (
                        <instancedMesh ref={meshRef} args={[null, null, 40]}>
                            <boxGeometry args={[0.4, 0.8, 0.4]} />
                            <meshStandardMaterial color="#D4AF37" metalness={0.9} roughness={0.1} />
                        </instancedMesh>
                    );
                };

                const App = () => {
                    const [status, setStatus] = useState('FORMED');

                    useEffect(() => {
                        const l = document.getElementById('loader');
                        if (l) { l.style.opacity = '0'; setTimeout(() => l.style.display = 'none', 500); }
                    }, []);

                    return (
                        <div className="w-full h-full relative">
                            <Canvas camera={{ position: [0, 5, 25], fov: 45 }}>
                                <Suspense fallback={null}>
                                    <Environment preset="city" />
                                    <Float>
                                        <mesh>
                                            <sphereGeometry args={[2, 32, 32]} />
                                            <MeshWobbleMaterial factor={0.4} color="#FFD700" emissive="#FF4500" />
                                        </mesh>
                                    </Float>
                                    <CarouselElements state={status} />
                                    <OrbitControls enablePan={false} />
                                </Suspense>
                                <ambientLight intensity={0.5} />
                                <pointLight position={[10, 10, 10]} />
                            </Canvas>

                            <div className="fixed bottom-10 left-1/2 -translate-x-1/2 z-50 flex gap-4">
                                <button onClick={() => setStatus('CHAOS')} className="px-6 py-2 rounded-full border border-yellow-500/50 text-white text-[10px] uppercase">Unleash</button>
                                <button onClick={() => setStatus('FORMED')} className="px-6 py-2 rounded-full bg-yellow-600 text-black text-[10px] uppercase font-bold">Restore</button>
                            </div>
                        </div>
                    );
                };

                const root = ReactDOM.createRoot(document.getElementById('root'));
                root.render(<App />);
            } catch (e) {
                document.getElementById('loader').innerHTML = `<p style="color:red; padding:20px;">加载失败: 无法访问 3D 引擎资源。请尝试更换网络环境或稍后再试。</p>`;
            }
        }

        initApp();
    </script>
</body>
</html>
