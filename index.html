import React, { useState, useRef, useMemo, useEffect, Suspense } from 'react';
import { Canvas, useFrame, useThree } from '@react-three/fiber';
import { 
  Float, 
  Environment, 
  Text, 
  OrbitControls, 
  PerspectiveCamera,
  MeshWobbleMaterial
} from '@react-three/drei';
import * as THREE from 'three';

// --- Â∏∏ÈáèÈÖçÁΩÆ ---
const INSTANCE_COUNT = 80; // ÈÄÇÂΩìÂáèÂ∞ëÂÆû‰æãÊï∞Èáè‰ª•Â¢ûÂº∫ÂÖºÂÆπÊÄß
const POLAROID_COUNT = 15; 
const STATE = { CHAOS: 'CHAOS', FORMED: 'FORMED' };

// --- Ê®°ÊãüÊâãÂäøÊéßÂà∂Âô® (‰ºòÂåñÂêéÁöÑ UI) ---
const GestureController = ({ onStateChange, currentState }) => {
  const videoRef = useRef(null);

  useEffect(() => {
    async function setupCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        if (videoRef.current) videoRef.current.srcObject = stream;
      } catch (err) {
        console.warn("Camera access denied");
      }
    }
    setupCamera();
  }, []);

  return (
    <div className="fixed bottom-6 left-6 z-50 p-5 bg-black/80 backdrop-blur-2xl rounded-3xl border border-yellow-500/30 text-white shadow-[0_0_50px_rgba(0,0,0,0.5)]">
      <div className="flex items-center gap-3 mb-4">
        <div className="w-2 h-2 rounded-full bg-yellow-500 animate-ping" />
        <h3 className="text-yellow-500 font-bold text-xs tracking-[0.2em] uppercase">Vision AI System</h3>
      </div>
      
      <div className="relative mb-4 overflow-hidden rounded-xl border border-white/5 bg-neutral-900">
        <video ref={videoRef} autoPlay playsInline muted className="w-48 h-36 object-cover grayscale brightness-50" />
        <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
          <div className="w-32 h-32 border border-yellow-500/20 rounded-full animate-[spin_10s_linear_infinite]" />
          <div className="absolute text-[8px] text-yellow-500/40 font-mono">SCANNING HAND...</div>
        </div>
      </div>

      <div className="grid grid-cols-2 gap-3">
        <button 
          onClick={() => onStateChange(STATE.CHAOS)}
          className={`py-3 rounded-xl text-[10px] uppercase tracking-tighter transition-all ${currentState === STATE.CHAOS ? 'bg-red-500 text-white shadow-[0_0_15px_rgba(239,68,68,0.5)]' : 'bg-white/5 border border-white/10 hover:bg-white/10'}`}
        >
          üñêÔ∏è Unleash
        </button>
        <button 
          onClick={() => onStateChange(STATE.FORMED)}
          className={`py-3 rounded-xl text-[10px] uppercase tracking-tighter transition-all ${currentState === STATE.FORMED ? 'bg-yellow-500 text-black font-bold shadow-[0_0_15px_rgba(234,179,8,0.5)]' : 'bg-white/5 border border-white/10 hover:bg-white/10'}`}
        >
          ‚úä Formed
        </button>
      </div>
    </div>
  );
};

// --- Êú®È©¨/Ë£ÖÈ•∞Áâ©ÁªÑ‰ª∂ ---
const CarouselElements = ({ state }) => {
  const meshRef = useRef();
  const tempObject = new THREE.Object3D();
  
  const data = useMemo(() => {
    return Array.from({ length: INSTANCE_COUNT }).map((_, i) => ({
      chaosPos: new THREE.Vector3((Math.random() - 0.5) * 50, (Math.random() - 0.5) * 50, (Math.random() - 0.5) * 50),
      angleOffset: (i / INSTANCE_COUNT) * Math.PI * 2,
      heightOffset: (Math.random() - 0.5) * 10,
      radiusOffset: 8 + Math.sin(i) * 2,
      speed: 0.01 + Math.random() * 0.02
    }));
  }, []);

  useFrame((stateFrame) => {
    const time = stateFrame.clock.getElapsedTime();
    const isChaos = state === STATE.CHAOS;

    data.forEach((item, i) => {
      let targetX, targetY, targetZ;
      let rotX = 0, rotY = 0, rotZ = 0;

      if (isChaos) {
        targetX = item.chaosPos.x;
        targetY = item.chaosPos.y;
        targetZ = item.chaosPos.z;
        rotX = time * item.speed * 10;
        rotY = time * item.speed * 10;
      } else {
        const currentAngle = item.angleOffset + time * 0.4;
        targetX = Math.cos(currentAngle) * item.radiusOffset;
        targetZ = Math.sin(currentAngle) * item.radiusOffset;
        targetY = item.heightOffset + Math.sin(time + i) * 0.5;
        rotY = -currentAngle + Math.PI / 2;
      }

      tempObject.position.lerp(new THREE.Vector3(targetX, targetY, targetZ), 0.06);
      tempObject.rotation.set(rotX, rotY, rotZ);
      tempObject.updateMatrix();
      meshRef.current.setMatrixAt(i, tempObject.matrix);
    });
    meshRef.current.instanceMatrix.needsUpdate = true;
  });

  return (
    <instancedMesh ref={meshRef} args={[null, null, INSTANCE_COUNT]}>
      <boxGeometry args={[0.4, 0.8, 0.4]} />
      <meshStandardMaterial color="#D4AF37" metalness={1} roughness={0.1} emissive="#221100" />
    </instancedMesh>
  );
};

// --- ÊãçÁ´ãÂæóÁÖßÁâáÁªÑ‰ª∂ ---
const Polaroid = ({ index, total, state }) => {
  const ref = useRef();
  const [chaosPos] = useState(() => new THREE.Vector3((Math.random() - 0.5) * 40, (Math.random() - 0.5) * 40, (Math.random() - 0.5) * 40));
  
  useFrame(({ clock }) => {
    const time = clock.getElapsedTime();
    const isChaos = state === STATE.CHAOS;
    const angle = (index / total) * Math.PI * 2 + time * 0.25;
    const targetPos = new THREE.Vector3(Math.cos(angle) * 14, Math.sin(index * 2 + time) * 2 + 3, Math.sin(angle) * 14);
    
    ref.current.position.lerp(isChaos ? chaosPos : targetPos, 0.05);
    if (!isChaos) {
      ref.current.lookAt(0, 3, 0);
    } else {
      ref.current.rotation.z += 0.01;
    }
  });

  return (
    <group ref={ref}>
      <mesh castShadow>
        <planeGeometry args={[2.5, 3]} />
        <meshStandardMaterial color="white" roughness={0.8} />
      </mesh>
      <mesh position={[0, 0.3, 0.02]}>
        <planeGeometry args={[2.2, 2.2]} />
        <meshStandardMaterial color={new THREE.Color().setHSL((index / total + 0.1) % 1, 0.5, 0.4)} emissive="#ffffff" emissiveIntensity={0.1} />
      </mesh>
      <Text
        position={[0, -1.1, 0.03]}
        fontSize={0.14}
        color="#222"
        font="https://fonts.gstatic.com/s/playfairdisplay/v30/nuFvD7K_RW7ePaDXvK6drp8.woff"
      >
        Golden Era #{index}
      </Text>
    </group>
  );
};

// --- ÁéØÂ¢ÉÈáëÁ≤â ---
const GoldRain = () => {
  const count = 2000;
  const positions = useMemo(() => {
    const p = new Float32Array(count * 3);
    for (let i = 0; i < count; i++) {
      p[i * 3] = (Math.random() - 0.5) * 50;
      p[i * 3 + 1] = (Math.random() - 0.5) * 30;
      p[i * 3 + 2] = (Math.random() - 0.5) * 50;
    }
    return p;
  }, []);

  const ref = useRef();
  useFrame(({ clock }) => {
    ref.current.rotation.y = clock.getElapsedTime() * 0.03;
    ref.current.position.y = Math.sin(clock.getElapsedTime() * 0.5) * 1;
  });

  return (
    <points ref={ref}>
      <bufferGeometry>
        <bufferAttribute attach="attributes-position" count={count} array={positions} itemSize={3} />
      </bufferGeometry>
      <pointsMaterial size={0.07} color="#FFD700" transparent opacity={0.5} blending={THREE.AdditiveBlending} />
    </points>
  );
};

// --- ‰∏ªÂú∫ÊôØ ---
const Scene = ({ state }) => {
  return (
    <>
      <PerspectiveCamera makeDefault position={[0, 8, 28]} fov={40} />
      <OrbitControls 
        enablePan={false} 
        maxDistance={60} 
        minDistance={10}
        autoRotate={state === STATE.FORMED}
        autoRotateSpeed={0.5}
      />
      
      <color attach="background" args={['#050300']} />
      <fog attach="fog" args={['#050300', 20, 70]} />

      <Suspense fallback={null}>
        <Environment preset="night" />
        
        {/* Âú∞Êùø‰∏éÈ°∂Â±ÇÁªìÊûÑ */}
        <group position={[0, -4, 0]}>
          <mesh rotation={[-Math.PI / 2, 0, 0]} receiveShadow>
            <circleGeometry args={[20, 64]} />
            <meshStandardMaterial color="#111" metalness={0.8} roughness={0.2} />
          </mesh>
          <mesh position={[0, 0.25, 0]}>
            <cylinderGeometry args={[10, 11, 0.5, 64]} />
            <meshStandardMaterial color="#8B4513" metalness={0.9} roughness={0.1} />
          </mesh>
        </group>

        {/* Ê†∏ÂøÉËÉΩÈáèÊ∫ê */}
        <Float speed={4} rotationIntensity={1} floatIntensity={2}>
          <mesh position={[0, 5, 0]}>
            <sphereGeometry args={[2.5, 32, 32]} />
            <MeshWobbleMaterial factor={0.5} speed={2} color="#FFD700" emissive="#FF4500" emissiveIntensity={3} />
          </mesh>
          <pointLight intensity={10} color="#FFD700" distance={20} />
        </Float>

        <CarouselElements state={state} />
        
        {Array.from({ length: POLAROID_COUNT }).map((_, i) => (
          <Polaroid key={i} index={i} total={POLAROID_COUNT} state={state} />
        ))}

        <GoldRain />
      </Suspense>

      <ambientLight intensity={0.2} />
      <spotLight position={[20, 40, 20]} angle={0.2} penumbra={1} intensity={5} color="#FFD700" castShadow />
      <rectAreaLight width={50} height={50} position={[0, -5, 0]} rotation={[-Math.PI/2, 0, 0]} intensity={2} color="#442200" />
    </>
  );
};

export default function App() {
  const [appState, setAppState] = useState(STATE.FORMED);

  return (
    <div className="w-full h-screen bg-[#050300] overflow-hidden select-none">
      {/* È°∂ÈÉ®Ê†áÈ¢òË£ÖÈ•∞ */}
      <div className="absolute top-12 left-0 w-full z-10 pointer-events-none px-10">
        <div className="flex flex-col items-center">
          <div className="text-[10px] tracking-[0.8em] text-yellow-500/40 uppercase mb-4">The Royal Interactive Experience</div>
          <h1 className="text-5xl md:text-8xl font-serif text-transparent bg-clip-text bg-gradient-to-b from-yellow-100 via-yellow-500 to-yellow-900 tracking-tighter italic">
            Grand Carousel
          </h1>
          <div className="h-[1px] w-full max-w-2xl bg-gradient-to-r from-transparent via-yellow-500/30 to-transparent mt-8" />
        </div>
      </div>

      {/* Áä∂ÊÄÅÂæΩÁ´† */}
      <div className="absolute top-1/2 right-12 -translate-y-1/2 z-10 hidden xl:flex flex-col items-end gap-10">
        <div className="text-right">
          <div className="text-yellow-500 text-[10px] tracking-widest uppercase mb-2 opacity-50">Current Dimension</div>
          <div className="text-white text-4xl font-serif italic tracking-wide">{appState}</div>
        </div>
        <div className="w-px h-32 bg-gradient-to-b from-transparent via-yellow-500/50 to-transparent" />
        <div className="max-w-[180px] text-right text-[11px] text-white/40 leading-relaxed uppercase tracking-tight">
          Interact with the AI vision system to toggle between architectural order and magical chaos.
        </div>
      </div>

      <Canvas shadows gl={{ antialias: true, alpha: false }}>
        <Scene state={appState} />
      </Canvas>

      <GestureController onStateChange={setAppState} currentState={appState} />

      {/* Â∫ïÈÉ®ÁâàÊùÉÊÑüË£ÖÈ•∞ */}
      <div className="absolute bottom-8 right-12 z-10 pointer-events-none opacity-20 text-[9px] uppercase tracking-[0.4em] text-white font-mono">
        R3F x React 19 x GSAP Hybrid Engine
      </div>

      <style jsx global>{`
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&display=swap');
        body { margin: 0; background: #050300; font-family: 'Playfair Display', serif; }
        ::selection { background: rgba(255, 215, 0, 0.2); }
      `}</style>
    </div>
  );
}
